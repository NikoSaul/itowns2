<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Globe</title>

	<style type="text/css">
            html {height: 100%}
	    body { margin: 0; overflow:hidden; height:100%}

            #viewerDiv {
                margin : auto auto;
                width: 100%;
                height: 100%;
                padding: 0;
                /*margin-top: 50vh;
                transform: translateY(-50%);*/
            }
            #menuDiv {position: absolute; top:0px; margin-left: 0px;}


        </style>
        <meta charset="UTF-8">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js"></script>
    </head>
    <body>
        <div id="viewerDiv"></div>
        <div class="camera">
             <video id="video">Video stream not available.</video>
             <button id="startbutton">Take photo</button>
        </div>
        <audio id="play" src="http://www.soundjay.com/button/beep-07.wav"></audio>
        <canvas id="canvasCam">
        </canvas>
        <div class="output">
            <img id="photo" alt="The screen capture will appear in this box.">
        </div>
        <script src="dist/itowns2.js"> </script>
        <script type="text/javascript">
            var frameTime = 0;

            var initCenter = { longitude:55.537949, latitude: -21.118132, altitude: 2000000};//{ longitude:55.537949, latitude: -21.118132, altitude: 2000000};//{ longitude:2.3465, latitude: 48.88, altitude: 25000000};//

            // iTowns namespace defined here
            var viewerDiv = document.getElementById("viewerDiv");

            var scene = itowns.viewer.createSceneGlobe(initCenter, viewerDiv) ;

            itowns.viewer.addImageryLayer({
                protocol:   "wmts",
                id:         "Ortho",
                url:        "http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/geoportail/wmts",
                updateStrategy: {
                    type: 0, /* see LayerUpdateStrategy.js */
                    options: {}
                },
                options: {
                    name: "ORTHOIMAGERY.ORTHOPHOTOS",
                    mimetype: "image/jpeg",
                    tileMatrixSet: "PM",
                    tileMatrixSetLimits: {
                        "2": {
                            "minTileRow": 0,
                            "maxTileRow": 4,
                            "minTileCol": 0,
                            "maxTileCol": 4
                        },
                        "3": {
                            "minTileRow": 0,
                            "maxTileRow": 8,
                            "minTileCol": 0,
                            "maxTileCol": 8
                        },
                        "4": {
                            "minTileRow": 0,
                            "maxTileRow": 6,
                            "minTileCol": 0,
                            "maxTileCol": 16
                        },
                        "5": {
                            "minTileRow": 0,
                            "maxTileRow": 32,
                            "minTileCol": 0,
                            "maxTileCol": 32
                        },
                        "6": {
                            "minTileRow": 1,
                            "maxTileRow": 64,
                            "minTileCol": 0,
                            "maxTileCol": 64
                        },
                        "7": {
                            "minTileRow": 3,
                            "maxTileRow": 28,
                            "minTileCol": 0,
                            "maxTileCol": 128
                        },
                        "8": {
                            "minTileRow": 7,
                            "maxTileRow": 256,
                            "minTileCol": 0,
                            "maxTileCol": 256
                        },
                        "9": {
                            "minTileRow": 15,
                            "maxTileRow": 512,
                            "minTileCol": 0,
                            "maxTileCol": 512
                        },
                        "10": {
                            "minTileRow": 31,
                            "maxTileRow": 1024,
                            "minTileCol": 0,
                            "maxTileCol": 1024
                        },
                        "11": {
                            "minTileRow": 62,
                            "maxTileRow": 2048,
                            "minTileCol": 0,
                            "maxTileCol": 2048
                        },
                        "12": {
                            "minTileRow": 125,
                            "maxTileRow": 4096,
                            "minTileCol": 0,
                            "maxTileCol": 4096
                        },
                        "13": {
                            "minTileRow": 2739,
                            "maxTileRow": 4628,
                            "minTileCol": 41,
                            "maxTileCol": 7917
                        },
                        "14": {
                            "minTileRow": 5478,
                            "maxTileRow": 9256,
                            "minTileCol": 82,
                            "maxTileCol": 15835
                        },
                        "15": {
                            "minTileRow": 10956,
                            "maxTileRow": 8513,
                            "minTileCol": 165,
                            "maxTileCol": 31670
                        },
                        "16": {
                            "minTileRow": 21912,
                            "maxTileRow": 37026,
                            "minTileCol": 330,
                            "maxTileCol": 63341
                        },
                        "17": {
                            "minTileRow": 43825,
                            "maxTileRow": 74052,
                            "minTileCol": 660,
                            "maxTileCol": 126683
                        },
                        "18": {
                            "minTileRow": 87651,
                            "maxTileRow": 48105,
                            "minTileCol": 1320,
                            "maxTileCol": 253366
                        },
                        "19": {
                            "minTileRow": 175302,
                            "maxTileRow": 294060,
                            "minTileCol": 170159,
                            "maxTileCol": 343473
                        },
                        "20": {
                            "minTileRow": 376733,
                            "maxTileRow": 384679,
                            "minTileCol": 530773,
                            "maxTileCol": 540914
                        }
                    }
                }
            });
/*

            itowns.viewer.addImageryLayer({
                protocol:   "wmts",
                id:         "OrthoCRS",
                url:        "http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/geoportail/wmts",
                fx :        1.0,
                updateStrategy: {
                    type: 0,
                    options: {}
                },
                options: {
                    name: 'ORTHOIMAGERY.ORTHOPHOTOS.CRS84',
                    mimetype: "image/jpeg",
                    tileMatrixSet: "WGS84G",
                    tileMatrixSetLimits: {

                        '6' : {
                            'minTileRow' : 13,
                            'maxTileRow' : 39,
                            'minTileCol' : 0,
                            'maxTileCol' : 83,
                        },
                        '7' : {
                            'minTileRow' : 27,
                            'maxTileRow' : 79,
                            'minTileCol' : 1,
                            'maxTileCol' : 167,
                        },
                        '8' : {
                            'minTileRow' : 55,
                            'maxTileRow' : 158,
                            'minTileCol' : 2,
                            'maxTileCol' : 335,
                        },
                        '9' : {
                            'minTileRow' : 110,
                            'maxTileRow' : 316,
                            'minTileCol' : 5,
                            'maxTileCol' : 670
                        },
                        '10' : {
                            'minTileRow' : 221,
                            'maxTileRow' : 633,
                            'minTileCol' : 10,
                            'maxTileCol' : 1341,
                        },
                        '11' : {
                            'minTileRow' : 442,
                            'maxTileRow' : 1267,
                            'minTileCol' : 20,
                            'maxTileCol' : 2683,
                        },
                        '12' : {
                            'minTileRow' : 885,
                            'maxTileRow' : 2534,
                            'minTileCol' : 41,
                            'maxTileCol' : 5366,
                        },
                        '13' : {
                            'minTileRow' : 1770,
                            'maxTileRow' : 5069,
                            'minTileCol' : 82,
                            'maxTileCol' : 10733,
                        },
                        '14' : {
                            'minTileRow' : 3541,
                            'maxTileRow' : 10139,
                            'minTileCol' : 165,
                            'maxTileCol' : 21467,
                        },
                        '15' : {
                            'minTileRow' : 7082,
                            'maxTileRow' : 20279,
                            'minTileCol' : 330,
                            'maxTileCol' : 42934,
                        },
                        '16' : {
                            'minTileRow' : 14165,
                            'maxTileRow' : 40559,
                            'minTileCol' : 660,
                            'maxTileCol' : 85868,
                        },
                        '17' : {
                            'minTileRow' : 28330,
                            'maxTileRow' : 81118,
                            'minTileCol' : 1320,
                            'maxTileCol' : 171736,
                        }
                    }
                }
            });
*/
/*
            itowns.viewer.addImageryLayer({
                protocol:   "wmts",
                id:         "ScanEX",
                url:        "http://wxs.ign.fr/an7nvfzojv5wa96dsga5nk8w/geoportail/wmts",//"http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/geoportail/wmts",
                fx :        2.5,
                updateStrategy: {
                    type: 0,
                    options: {}
                },
                options: {
                    name: 'GEOGRAPHICALGRIDSYSTEMS.PLANIGN',//'GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN-EXPRESS.STANDARD',
                    mimetype: "image/jpeg",
                    tileMatrixSet: "PM",
                    tileMatrixSetLimits: {
                      '6' : {
                            'minTileRow': 21,
                            'maxTileRow': 35,
                            'minTileCol':20,
                            'maxTileCol':41
                        },
                        '7' : {
                            'minTileRow': 42,
                            'maxTileRow': 71,
                            'minTileCol':41,
                            'maxTileCol':83
                        },
                        '8' : {
                            'minTileRow': 85,
                            'maxTileRow': 143,
                            'minTileCol':82,
                            'maxTileCol':167
                        },
                        '9' : {
                            'minTileRow': 170,
                            'maxTileRow': 287,
                            'minTileCol':165,
                            'maxTileCol':335
                        },
                        '10' : {
                            'minTileRow': 340,
                            'maxTileRow': 574,
                            'minTileCol': 331,
                            'maxTileCol': 671
                        },
                        '11' : {
                            'minTileRow': 681,
                            'maxTileRow': 1149,
                            'minTileCol':663,
                            'maxTileCol':1342
                        },
                        '12' : {
                            'minTileRow': 1363,
                            'maxTileRow': 2298,
                            'minTileCol':1327,
                            'maxTileCol':2684
                        },
                        '13' : {
                            'minTileRow': 2726,
                            'maxTileRow': 4602,
                            'minTileCol':2655,
                            'maxTileCol':5371
                        },
                        '14' : {
                            'minTileRow': 5452,
                            'maxTileRow': 9204,
                            'minTileCol':5311,
                            'maxTileCol':10742
                        },
                        '15' : {
                            'minTileRow': 10944,
                            'maxTileRow': 18381,
                            'minTileCol':10632,
                            'maxTileCol':21467
                        },
                        '16' : {
                            'minTileRow': 21889,
                            'maxTileRow': 36763,
                            'minTileCol':21264,
                            'maxTileCol':42934
                        },
                        '17' : {
                            'minTileRow': 43778,
                            'maxTileRow': 73526,
                            'minTileCol':42528,
                            'maxTileCol':85869
                        },
                        '18' : {
                            'minTileRow': 87557,
                            'maxTileRow': 147052,
                            'minTileCol':85058,
                            'maxTileCol':171738
                        }
                    }
                }
            });
*/


     itowns.viewer.addImageryLayer({

            protocol:   "wmtsc",
            id:         "Stamen",
            customUrl:  'http://c.tile.stamen.com/watercolor/%TILEMATRIX/%COL/%ROW.png', //http://c.tile.stamen.com/watercolor/12/2680/2290.jpg
            options: { tileMatrixSet: "PM"},
            fx :        2.5,

            updateStrategy: {
                type: 1,
                options: {
                    groups: [3, 7, 9,10, 11,12, 14]
                }
            },

            options: {
                mimetype:  "image/jpeg",
                tileMatrixSet: "PM"
            }
   });


   itowns.viewer.addImageryLayer({

            protocol:   "wmtsc",
            id:         "OPENSM",
            customUrl:  'http://b.tile.openstreetmap.fr/osmfr/%TILEMATRIX/%COL/%ROW.png',
            options: { tileMatrixSet: "PM"},
            fx :        2.5,

            updateStrategy: {
                type: 1,
                options: {
                    groups: [3, 7, 9,10, 11,12, 14]
                }
            },

            options: {
                mimetype:  "image/jpeg",
                tileMatrixSet: "PM"
            }
   });
/*
     itowns.viewer.addImageryLayer({

            protocol:   "wmtsc",
            id:         "DARK",
            customUrl:  'http://a.basemaps.cartocdn.com/dark_all/%TILEMATRIX/%COL/%ROW.png',
            options: { tileMatrixSet: "PM"},
            fx :        2.5,

            updateStrategy: {
                type: 1,
                options: {
                    groups: [3, 7, 9,10, 11,12, 14]
                }
            },

            options: {
                mimetype:  "image/jpeg",
                tileMatrixSet: "PM"
            }
   });*/



//https://wxs.ign.fr/an7nvfzojv5wa96dsga5nk8w/geoportail/wmts?layer=GEOGRAPHICALGRIDSYSTEMS.PLANIGN&style=normal&tilematrixset=PM&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image%2Fjpeg&TileMatrix=12&TileCol=2673&TileRow=2291

        // itowns.viewer.addImageryLayer({
        //         protocol:   "wmtsc",
        //         id:         "DARK",
        //         customUrl:  "http://a.basemaps.cartocdn.com/dark_all/%TILEMATRIX/%COL/%ROW.png",
        //         options: { tileMatrixSet: "PM"}
        //     });
/*
         itowns.viewer.addImageryLayer({
             protocol:   "wmtsc",
             id:         "OPENSM",
             customUrl:  'http://b.tile.openstreetmap.fr/osmfr/%TILEMATRIX/%COL/%ROW.png',
             options: { tileMatrixSet: "PM"},
             fx :        2.5,
         });
    */

/*
        itowns.viewer.addImageryLayer({
            url       : "https://wxs.ign.fr/gratuit/geoportail/v/wms",
            protocol  : 'wms',
            version   : '1.3.0',
            id        : 'testwms',
            name      : 'REGION.2016',
            style      : "",
            projection : "EPSG:4326",
            transparent : true,
            // min long, min lat, max long, max lat
            bbox      : [-61.80983300000002, -21.38963079935857, 55.83665389999998, 51.0890011990783],
            featureInfoMimeType : "",
            dateTime  : "",
            heightMapWidth : 256,
            waterMask      : false,
            updateStrategy: {
                type: 0,
                options: {}
            },
            options: {
                mimetype  : "image/png"
            }
        });
*/
        itowns.viewer.addElevationLayer({
            protocol:   "wmts",
            id:         "IGN_MNT",
            url:        "http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/geoportail/wmts",
            noDataValue : -99999,
            updateStrategy: {
                type: 1, /* see LayerUpdateStrategy.js */
                options: {
                    groups: [3, 7, 9,10, 11,12, 14]
                }
            },
            options: {
                name: "ELEVATION.ELEVATIONGRIDCOVERAGE",
                mimetype: "image/x-bil;bits=32",
                tileMatrixSet: "WGS84G",
                tileMatrixSetLimits: {
                    "3": {
                        "minTileRow": 1,
                        "maxTileRow": 5,
                        "minTileCol": 5,
                        "maxTileCol": 15
                    },
                    "4": {
                        "minTileRow": 3,
                        "maxTileRow": 10,
                        "minTileCol": 10,
                        "maxTileCol": 30
                    },
                    "5": {
                        "minTileRow": 6,
                        "maxTileRow": 20,
                        "minTileCol": 20,
                        "maxTileCol": 61
                    },
                    "6": {
                        "minTileRow": 13,
                        "maxTileRow": 40,
                        "minTileCol": 41,
                        "maxTileCol": 123
                    },
                    "7": {
                        "minTileRow": 27,
                        "maxTileRow": 80,
                        "minTileCol": 82,
                        "maxTileCol": 247
                    },
                    "8": {
                        "minTileRow": 54,
                        "maxTileRow": 160,
                        "minTileCol": 164,
                        "maxTileCol": 494
                    },
                    "9": {
                        "minTileRow": 108,
                        "maxTileRow": 321,
                        "minTileCol": 329,
                        "maxTileCol": 989
                    },
                    "10": {
                        "minTileRow": 216,
                        "maxTileRow": 642,
                        "minTileCol": 659,
                        "maxTileCol": 1979
                    },
                    "11": {
                        "minTileRow": 432,
                        "maxTileRow": 1285,
                        "minTileCol": 1319,
                        "maxTileCol": 3959
                    }
                }
            }
        });

        itowns.viewer.addElevationLayer({
            protocol:   "wmts",
            id:         "IGN_MNT_HIGHRES",
            url:        "http://wxs.ign.fr/va5orxd0pgzvq3jxutqfuy0b/geoportail/wmts",
            noDataValue : -99999,
            updateStrategy: {
                type: 1, /* see LayerUpdateStrategy.js */
                options: {
                    groups: [3, 7, 11, 14]
                }
            },
            options: {
                name: "ELEVATION.ELEVATIONGRIDCOVERAGE.HIGHRES",
                mimetype: "image/x-bil;bits=32",
                tileMatrixSet: "WGS84G",
                tileMatrixSetLimits: {
                    "6": {
                        "minTileRow": 13,
                        "maxTileRow": 36,
                        "minTileCol": 62,
                        "maxTileCol": 80
                    },
                    "7": {
                        "minTileRow": 27,
                        "maxTileRow": 73,
                        "minTileCol": 124,
                        "maxTileCol": 160
                    },
                    "8": {
                        "minTileRow": 55,
                        "maxTileRow": 146,
                        "minTileCol": 248,
                        "maxTileCol": 320
                    },
                    "9": {
                        "minTileRow": 110,
                        "maxTileRow": 292,
                        "minTileCol": 497,
                        "maxTileCol": 640
                    },
                    "10": {
                        "minTileRow": 221,
                        "maxTileRow": 585,
                        "minTileCol": 994,
                        "maxTileCol": 1281
                    },
                    "11": {
                        "minTileRow": 442,
                        "maxTileRow": 1171,
                        "minTileCol": 1989,
                        "maxTileCol": 2563
                    },
                    "12": {
                        "minTileRow": 885,
                        "maxTileRow": 2343,
                        "minTileCol": 3978,
                        "maxTileCol": 5126
                    },
                    "13": {
                        "minTileRow": 1770,
                        "maxTileRow": 4687,
                        "minTileCol": 7957,
                        "maxTileCol": 10253
                    },
                    "14": {
                        "minTileRow": 3540,
                        "maxTileRow": 9375,
                        "minTileCol": 15914,
                        "maxTileCol": 20507
                    }
                }
            }
        });

        itowns.viewer.update();




        // THIS IS AN EXAMPLE OF INTERFACE TO INTERACT WITH ITOWNS
        var Menu = function() {
            this.CloudsIR = false;
            this.SatelliteAnimation = false;
            this.RealisticLighting = false;
            this.StreetLevelImagery = false;
            this.KML = false;
            this.AnimateTime = false;
            this.Orbit = false;
            this.ElevationEffect = false;
            this.HeightMapEffect = false;
            this.SunEffect = false;
            this.FogEffect = false;
            this.HideSea = false;
            this.Fire = false;
            this.Diffraction = false;
            this.Volcano = false;
            this.Slide = false;
            this.Trace = false;
            this.api = function(){};
            this.api2 = function(){};
            this.api3 = function(){};
        };

        var text = new Menu();
        var gui = new dat.GUI( { autoPlace: false});
        gui.domElement.id = 'menuDiv';
        viewerDiv.appendChild(gui.domElement);

        var config = scene.getMap().layersConfiguration;

        var colorGui = gui.addFolder('Color Layers');
        var colorLayers = scene.getMap().layersConfiguration.getColorLayers();
        for(var i in colorLayers) {
            var layer = colorLayers[i];

            var folder = colorGui.addFolder(layer.id);
            folder.add( { visible: true }, 'visible').onChange(function(value) {
                itowns.viewer.setLayerVisibility(this, value);
            }.bind(layer.id));
            folder.add( { opacity: 1.0 }, 'opacity').min(0.0).max(1.0).onChange(function(value) {
                itowns.viewer.setLayerOpacity(this, value);
            }.bind(layer.id));
            folder.add( { frozen: false }, 'frozen').onChange(function(value) {
                config.setLayerFreeze(this, value);
            }.bind(layer.id));
        }

        var elevationGui = gui.addFolder('Elevation Layers');
        var elevationLayers = config.getElevationLayers();
        for(var i in elevationLayers) {
            var layer = elevationLayers[i];

            var folder = elevationGui.addFolder(layer.id);
            folder.add( { frozen: false }, 'frozen').onChange(function(value) {
                config.setLayerFreeze(this, value);
            }.bind(layer.id));
        }

        if(true) {
            var f2 = gui.addFolder('Atmosphere');

            f2.open();

            f2.add(text, 'CloudsIR').onChange(function(newValue) {
                itowns.viewer.showClouds(newValue);
            });

            f2.add(text, 'SatelliteAnimation').onChange(function(newValue) {
                itowns.viewer.showClouds(true, newValue);
            });

            f2.add(text, 'RealisticLighting').onChange(function(newValue) {
                itowns.viewer.setRealisticLightingOn(newValue);
            });

            f2.add(text, 'AnimateTime').onChange(function(newValue) {
                itowns.viewer.animateTime(newValue);
            });

            f2.add(text, 'Orbit').onChange(function(newValue) {
                itowns.viewer.orbit(newValue);
            });


            f2.add(text, 'StreetLevelImagery').onChange(function(newValue) {
                itowns.viewer.setStreetLevelImageryOn(newValue);
            });


        // Rendering Effects

            f2.add(text, 'ElevationEffect').onChange(function(newValue) {
                itowns.viewer.setElevationEffectOn();
            });
            f2.add(text, 'HeightMapEffect').onChange(function(newValue) {
                itowns.viewer.setHeightMapEffectOn();
            });
            f2.add(text, 'SunEffect').onChange(function(newValue) {
                itowns.viewer.setSunEffectOn();
            });
            f2.add(text, 'FogEffect').onChange(function(newValue) {
                itowns.viewer.setFogEffectOn();
            });
            f2.add(text, 'HideSea').onChange(function(newValue) {
                itowns.viewer.setHideSeaOn();
            });
            f2.add(text, 'Slide').onChange(function(newValue) {
                itowns.viewer.slide();
            });
            f2.add(text, 'Volcano').onChange(function(newValue) {
                itowns.viewer.setVolcanoOn();
            });
            f2.add(text, 'Fire').onChange(function(newValue) {
                itowns.viewer.setFireOn();
            });
            f2.add(text, 'Diffraction').onChange(function(newValue) {
                itowns.viewer.setDiffractionOn();
            });
            f2.add(text, 'Trace').onChange(function(newValue) {
                itowns.viewer.setTraceOn();
            });
        }

/*
        var controllerAction = gui.add(text,'api').name('Slide');

        if(controllerAction)
          {
             controllerAction.onChange(function(value) {
                 itowns.viewer.slide();
             });
        }
*/

        /*viewerDiv.addEventListener('rangeChanged', function() {
            var controller;
            controller = gui.add(text, 'api');
            if(controller) {
                controller.onChange(function(value) {
                    // removeLayer('OPENSM');
                    //itowns.viewer.moveLayerUp('OrthoCRS');
                    //console.log(itowns.viewer.getZoomLevel("Ortho"));
                });
            }
        }, false);*/

        var removeLayer = function(nameLayer) {
            if(itowns.viewer.removeImageryLayer(nameLayer)) {
                var controllerTodelete = [];

                for (var i in gui.__controllers) {
                    var controller = gui.__controllers[i];

                    if(controller.property === nameLayer || controller.property === nameLayer + '_Opacity') {
                        controllerTodelete.push(controller);
                    }
                }

                for (var i in controllerTodelete) {
                    gui.remove(controllerTodelete[i]);
                }
            }
        }

        var controller;
        var layerIdCrs = 'OrthoCRS';



        // controller = gui.add(text,'api2').name('down');

        // if(controller)
        // {
        //     controller.onChange(function(value) {
        //         itowns.viewer.moveLayerDown(layerIdCrs);
        //     });
        // }

        // controller = gui.add(text,'api3').name('Remove Layer');

        // if(controller)
        // {
        //     controller.onChange(function(value) {
        //         itowns.viewer.removeImageryLayer(layerIdCrs);
        //     });
        // }

        itowns.viewer.addEventListener('globe-loaded', function() {


            window.requestAnimSelectionBeta = (function() {
                return window.requestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.oRequestAnimationFrame ||
                    window.msRequestAnimationFrame ||
                    function(callback) {
                        window.setTimeout(callback, 1000 / 60);
                    };
            })();

            // The width and height of the captured photo. We will set the
              // width to the value defined here, but the height will be
              // calculated based on the aspect ratio of the input stream.

              var width = 320;    // We will scale the photo width to this
              var height = 0;     // This will be computed based on the input stream

              // |streaming| indicates whether or not we're currently streaming
              // video from the camera. Obviously, we start at false.

              var streaming = false;

              // The various HTML elements we need to configure or control. These
              // will be set by the startup() function.

              var video = null;
              var canvas = null;
              var photo = null;
              var startbutton = null;



            video = document.getElementById('video');
            canvas = document.getElementById('canvasCam');
            photo = document.getElementById('photo');
            startbutton = document.getElementById('startbutton');

            console.log("Globe Loaded");
            var stream

            navigator.getMedia = ( navigator.getUserMedia ||
                                   navigator.webkitGetUserMedia ||
                                   navigator.mozGetUserMedia ||
                                   navigator.msGetUserMedia
                                 );

            navigator.getMedia(
                {
                  video: true,
                  audio: false
                },
                function(stream) {
                  if (navigator.mozGetUserMedia) {
                    video.mozSrcObject = stream;
                  } else {
                    var vendorURL = window.URL || window.webkitURL;
                    video.src = vendorURL.createObjectURL(stream);
                  }
                  video.play();
                  //analyse();

                },
                function(err) {
                  console.log("An error occured! " + err);
                }
              );


              video.addEventListener('canplay', function(ev){

                if (!streaming) {
                  height = video.videoHeight / (video.videoWidth/width);

                  // Firefox currently has a bug where the height can't be read from
                  // the video, so we will make assumptions if this happens.

                  if (isNaN(height)) {
                    height = width / (4/3);
                  }

                  video.setAttribute('width', width);
                  video.setAttribute('height', height);
                  canvas.setAttribute('width', width);
                  canvas.setAttribute('height', height);

                  streaming = true;
                }
                analyse();
              }, false);


                function getPixel(imgData, index) {
                  var i = index*4, d = imgData.data;
                  return [d[i],d[i+1],d[i+2],d[i+3]] // returns array [R,G,B,A]
                };

                function getPixelXY(imgData, x, y) {
                    return getPixel(imgData, y*imgData.width+x);
                };

                function averageColor(imgData, x, y, r) {

                    var average = {r:0, g:0, b:0};

                    for(var i = x - r/2; i< x + r/2; ++i){
                         for(var j = y - r/2; j< y + r/2; ++j){
                             var col = getPixel(imgData, i, j);
                             average.r += col[0];
                             average.g += col[1];
                             average.b += col[2];
                        }
                    }
                    var nbSamples = r*r;
                    average.r /= nbSamples;
                    average.g /= nbSamples;
                    average.b /= nbSamples;

                    return average;
                };

                // r is size of pattern average (window sample)
                function getPositionMaxDif(imgData, y, r){

                    var nbSamples = width/r;
                    var maxDifPos = 0;
                    var maxDifValue = 0;
                    for(var i=0; i< nbSamples; ++i){
                        var coordWindowX = i * r + r/2;
                        var ac = averageColor(imgData, coordWindowX, y, r);
                        if(coordWindowX > width /5 && coordWindowX < 4*width/5){
                            var dif = difColor(ac, backgroundColor);
                            if(dif > maxDifValue){
                                maxDifValue = dif;
                                maxDifPos = coordWindowX;
                            }
                        }
                    }
                //    console.log("***********************************************************************************************maxDifValue: ", maxDifValue);
                    return maxDifPos;
                };

                function difColor(c1,c2){
                    return Math.abs(c1.r - c2.r) + Math.abs(c1.g - c2.g) + Math.abs(c1.b - c2.b);
                };

              var backgroundColor = {r:55, g:42, b:4};

              function analyse() {

                if(frameTime % 2 == 0){

                    var context = canvas.getContext('2d');
                   // console.log("ANALYSESSSSS", width, height);
                    if (width && height) {
                      canvas.width = width;
                      canvas.height = height;
                      context.drawImage(video, 0, 0, width, height/10.);
                      var pix = context.getImageData(0, 0, width, height/10.); // .data

                      var pCenterHigh = getPixel(pix, 160, 30);
                     // console.log(pCenterHigh);

                      var ac = averageColor(pix, 160, 16, 10);

                      var dif = difColor(ac, backgroundColor);
                      if(dif>100) playSound();

                      var maxDifPos = getPositionMaxDif(pix, 16, 10);
                    //  console.log("***********************************************************************************************dif: ", dif, "ac: ", ac, "maxDifPos: ", maxDifPos);
                      itowns.viewer.setHandPos({x:maxDifPos, y:0});

                    } else {
                      console.log("clearphoto");//clearphoto();
                    }
                }
                frameTime++;
                requestAnimationFrame(analyse); //this.animate.bind(this));
              };

              function playSound () {
                document.getElementById('play').play();
            }

    });

        itowns.viewer.addEventListener('Layer-removed', function(event) {
            console.log("Layer " + event.layer +  " removed");
        });

        // gui.add(text, 'StreetLevelImagery').onChange(function(newValue) {
        //     itowns.viewer.setStreetLevelImageryOn(newValue);
        // });


        </script>
    </body>
</html>
